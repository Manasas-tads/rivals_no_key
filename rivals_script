local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local ESPEnabled = false  -- Track if ESP is enabled

-- Create the UI container
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")  -- Ensure UI is in PlayerGui
screenGui.Name = "ESP_UI"

local uiContainer = Instance.new("Frame")
uiContainer.Size = UDim2.new(0, 250, 0, 120)  -- Adjust the size to create some space
uiContainer.Position = UDim2.new(0.5, -125, 0, 10)
uiContainer.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
uiContainer.BackgroundTransparency = 0.5
uiContainer.Parent = screenGui

-- Apply rounded corners using UICorner
local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 15)  -- Round the corners of the container
uiCorner.Parent = uiContainer

-- Create the text label for ESP
local espTextLabel = Instance.new("TextLabel")
espTextLabel.Size = UDim2.new(0, 200, 0, 40)
espTextLabel.Position = UDim2.new(0, 0, 0, 0)
espTextLabel.Text = "ESP"
espTextLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
espTextLabel.BackgroundTransparency = 1
espTextLabel.Font = Enum.Font.SourceSans
espTextLabel.TextSize = 24
espTextLabel.TextXAlignment = Enum.TextXAlignment.Left
espTextLabel.Parent = uiContainer

-- Create a button to toggle ESP
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 200, 0, 40)
toggleButton.Position = UDim2.new(0, 0, 0, 50)
toggleButton.Text = "Enable ESP"
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.BackgroundColor3 = Color3.fromRGB(0, 128, 0)  -- Green color for OFF
toggleButton.Font = Enum.Font.SourceSans
toggleButton.TextSize = 24
toggleButton.Parent = uiContainer

-- Create UICorner for rounding the corners of the button
local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 20)  -- Round the corners of the button
buttonCorner.Parent = toggleButton

-- Function to highlight a player
local function highlightPlayer(player)
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        -- Check if highlight already exists
        if not player.Character:FindFirstChild("Highlight") then
            local highlight = Instance.new("Highlight")
            highlight.Parent = player.Character
            highlight.FillColor = Color3.fromRGB(255, 255, 0) -- Yellow color
            highlight.OutlineColor = Color3.fromRGB(0, 0, 0) -- Black outline
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop -- Visible through walls
        end
    end
end

-- Function to create a floating name tag
local function createNameTag(player)
    if player.Character and player.Character:FindFirstChild("Head") then
        local head = player.Character.Head

        -- Check if nametag already exists
        if head:FindFirstChild("NameTag") then return end

        local billboard = Instance.new("BillboardGui")
        billboard.Name = "NameTag"
        billboard.Adornee = head
        billboard.Size = UDim2.new(4, 0, 1, 0) -- Adjust size
        billboard.StudsOffset = Vector3.new(0, 2.5, 0) -- Position above head
        billboard.AlwaysOnTop = true
        billboard.Parent = head

        local textLabel = Instance.new("TextLabel")
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.BackgroundTransparency = 1
        textLabel.Text = player.Name
        textLabel.Font = Enum.Font.SourceSansBold
        textLabel.TextSize = 20
        textLabel.TextColor3 = Color3.fromRGB(255, 255, 255) -- White text
        textLabel.Parent = billboard
    end
end

-- Function to remove highlights and name tags for a player
local function removeESP(player)
    if player.Character then
        -- Remove highlight
        if player.Character:FindFirstChild("Highlight") then
            player.Character.Highlight:Destroy()
        end

        -- Remove name tag
        if player.Character:FindFirstChild("Head") and player.Character.Head:FindFirstChild("NameTag") then
            player.Character.Head.NameTag:Destroy()
        end
    end
end

-- Function to apply highlights and name tags to all players
local function updatePlayers()
    for _, player in pairs(Players:GetPlayers()) do
        if ESPEnabled then
            highlightPlayer(player)
            createNameTag(player)
        else
            removeESP(player)
        end
    end
end

-- Function to toggle ESP on and off
local function toggleESP()
    ESPEnabled = not ESPEnabled

    -- Update the button text and color
    if ESPEnabled then
        toggleButton.Text = "Disable ESP"
        toggleButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)  -- Red color for ON
    else
        toggleButton.Text = "Enable ESP"
        toggleButton.BackgroundColor3 = Color3.fromRGB(0, 128, 0)  -- Green color for OFF
    end

    -- Apply or remove ESP from all players based on the toggle state
    updatePlayers()
end

-- Connect the button to toggle ESP
toggleButton.MouseButton1Click:Connect(function()
    toggleESP()
end)

-- Apply to existing players
updatePlayers()

-- Listen for new players joining
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        if ESPEnabled then
            highlightPlayer(player)
            createNameTag(player)
        end
    end)
end)

-- Continuously update highlights & name tags in case players reset their characters
RunService.Heartbeat:Connect(updatePlayers)
